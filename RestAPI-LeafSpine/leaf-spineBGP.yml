name: leaf-spine
topology:
  nodes:
    spine1:
      kind: linux
      image: frrouting/frr
      binds:
        - spine1/daemons:/etc/frr/daemons
        - spine1/frr.conf:/etc/frr/frr.conf
      group: spine
      
    spine2:
      kind: linux
      image: frrouting/frr
      binds:
        - spine2/daemons:/etc/frr/daemons
        - spine2/frr.conf:/etc/frr/frr.conf
      group: spine
        
    leaf1:
      kind: linux
      image: frrouting/frr
      binds:
        - leaf1/daemons:/etc/frr/daemons
        - leaf1/frr.conf:/etc/frr/frr.conf
        - leaf1/setup-vxlan.sh:/etc/frr/setup-vxlan.sh
      group: leaf
      exec:
        - chmod +x /etc/frr/setup-vxlan.sh
        - ./etc/frr/setup-vxlan.sh

    leaf2:
      kind: linux
      image: frrouting/frr
      binds:
        - leaf2/daemons:/etc/frr/daemons
        - leaf2/frr.conf:/etc/frr/frr.conf
        - leaf2/setup-vxlan.sh:/etc/frr/setup-vxlan.sh
      group: leaf
      exec:
        - chmod +x /etc/frr/setup-vxlan.sh
        - ./etc/frr/setup-vxlan.sh

    leaf3:
      kind: linux
      image: frrouting/frr
      binds:
        - leaf3/daemons:/etc/frr/daemons
        - leaf3/frr.conf:/etc/frr/frr.conf
        - leaf3/setup-vxlan.sh:/etc/frr/setup-vxlan.sh
      group: leaf
      exec:
        - chmod +x /etc/frr/setup-vxlan.sh
        - ./etc/frr/setup-vxlan.sh     
    PC1:
      kind: linux
      image: wbitt/network-multitool
      exec:
        - ip addr add 192.168.1.11/24 dev eth1 broadcast 192.168.1.255
        - sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=0
      group: server

    PC2:
      kind: linux
      image: wbitt/network-multitool
      exec:
        - ip addr add 192.168.1.12/24 dev eth1 broadcast 192.168.1.255
        - sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=0
      group: server
      
    PC3:
      kind: linux
      image: my-ubuntu-rest
      binds:
        - ./Database.py:/tmp/Database.py
      exec:
        - ip addr add 192.168.1.21/24 dev eth1 broadcast 192.168.1.255
        - sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=0
        - cp /tmp/Database.py /RestApi/Script/Database.py
        - rm /RestApi/Script/Student.py
      group: server

    PC4:
      kind: linux
      image: my-ubuntu-apache
      binds:
        - IndexPC4/index.html:/tmp/index.html
      exec:
        - ip addr add 192.168.1.21/24 dev eth1 broadcast 192.168.1.255
        - sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=0
        - rm /var/www/html/index.html
        - cp /tmp/index.html /var/www/html/index.html
        - apt-get update
        - apt-get install curl
        - service apache2 start
      group: server

    PC5:
      kind: linux
      image: my-ubuntu-rest
      binds:
        - VolumeServer:/RestApi/Script/VolumeServer
      exec:
        - ip addr add 192.168.1.41/24 dev eth1 broadcast 192.168.1.255
        - sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=0
        - rm /RestApi/Script/Student.py
      group: server

    PC6:
      kind: linux
      image: my-ubuntu-apache
      binds:
        - IndexPC6/index.html:/tmp/index.html
      exec:
        - ip addr add 192.168.1.42/24 dev eth1 broadcast 192.168.1.255
        - sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=0
        - rm /var/www/html/index.html
        - cp /tmp/index.html /var/www/html/index.html
        - apt-get update
        - apt-get install curl
        - service apache2 start
      group: server
        
  links:
    - endpoints: ["PC1:eth1", "leaf1:eth2"]
    - endpoints: ["PC2:eth1", "leaf1:eth3"]
    - endpoints: ["PC3:eth1", "leaf2:eth2"]
    - endpoints: ["PC4:eth1", "leaf2:eth3"]
    - endpoints: ["PC5:eth1", "leaf3:eth2"]
    - endpoints: ["PC6:eth1", "leaf3:eth3"]
    - endpoints: ["spine1:eth1", "leaf1:eth1"]
    - endpoints: ["spine1:eth2", "leaf2:eth1"]
    - endpoints: ["spine1:eth3", "leaf3:eth1"]
    - endpoints: ["spine2:eth1", "leaf1:eth4"]
    - endpoints: ["spine2:eth2", "leaf2:eth4"]
    - endpoints: ["spine2:eth3", "leaf3:eth4"]

